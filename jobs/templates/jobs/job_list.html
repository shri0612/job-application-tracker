{% extends "base.html" %}
{% block content %}

<style>
    body { font-family: Arial, sans-serif; margin: 20px; }

    h1 { margin-bottom: 12px; }

    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }

    .btn {
        padding: 6px 10px;
        text-decoration: none;
        border-radius: 4px;
        font-size: 14px;
        display: inline-block;
        cursor: pointer;
        border: none;
    }

    /* FIXED CONTRAST */
    .btn-add { background: #0b5ed7; color: #ffffff; }
    .btn-edit { background: #8a4b00; color: #ffffff; }   /* stronger contrast */
    .btn-delete { background: #b02a37; color: #ffffff; }

    .badge {
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 12px;
        color: #fff;
    }

    /* STATUS COLORS (WCAG compliant) */
    .Applied { background: #0d6efd; }
    .Interview { background: #b08900; }
    .Offer { background: #238c5a; }
    .Rejected { background: #c53030; }
    .Wishlist { background: #555; }

    .notes-cell {
        max-width: 250px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* MODAL USING <dialog> */
    dialog {
        border: none;
        padding: 0;
        border-radius: 6px;
        width: 450px;
        max-width: 90%;
        box-shadow: 0 2px 10px rgba(0,0,0,0.35);
    }

    dialog::backdrop {
        background: rgba(0,0,0,0.45);
    }

    .modal-box {
        padding: 20px;
        position: relative;
        background: #fff;
    }

    .modal-close-btn {
        position: absolute;
        top: 4px;
        right: 10px;
        background: none;
        border: none;
        font-size: 32px;
        font-weight: bold;
        cursor: pointer;
        color: #333;
    }

    .modal-close-btn:focus {
        outline: 2px solid #0d6efd;
    }
</style>

<div class="container py-4">
    <h1>All Jobs</h1>
    <p>Welcome, {{ user.username }}!</p>

    <a href="{% url 'add_job' %}" class="btn btn-add">+ Add New Job</a>

    {% if jobs %}
    <table>
        <thead>
            <tr>
                <th>Job Title</th>
                <th>Company</th>
                <th>Status</th>
                <th>Date Applied</th>
                <th>Notes</th>
                <th>Actions</th>
            </tr>
        </thead>

        <tbody>
            {% for job in jobs %}
            <tr>
                <td>{{ job.title }}</td>
                <td>{{ job.company }}</td>

                <td><span class="badge {{ job.status }}">{{ job.status }}</span></td>

                <td>
                    {% if job.date_applied %}
                        {{ job.date_applied|date:"d M Y" }}
                    {% else %} — {% endif %}
                </td>

                <!-- NOTES BUTTON (Accessible) -->
                <td>
                    {% if job.notes %}
                        <button
                            class="btn btn-add"
                            onclick="showNotes('{{ job.notes|escapejs }}')"
                            aria-label="View notes for {{ job.title }}">
                            View Notes
                        </button>
                    {% else %}
                        —
                    {% endif %}
                </td>

                <td>
                    <a href="{% url 'edit_job' job.id %}" class="btn btn-edit">Edit</a>
                    <a href="{% url 'delete_job' job.id %}" class="btn btn-delete">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% else %}
        <p>No jobs found. Start by adding one.</p>
    {% endif %}
</div>

<!-- ACCESSIBLE <dialog> MODAL -->
<dialog id="notesModal">
    <div class="modal-box">
        <button 
            class="modal-close-btn"
            onclick="closeNotes()"
            aria-label="Close notes">
            &times;
        </button>

        <h3>Full Notes</h3>
        <p id="notesContent"></p>
    </div>
</dialog>

<script>
    const modal = document.getElementById('notesModal');
    const notesContent = document.getElementById('notesContent');

    function showNotes(noteText) {
        notesContent.textContent = noteText;
        modal.showModal();
    }

    function closeNotes() {
        modal.close();
    }

    // Accessible keyboard escape handling (Sonar rule fix)
    globalThis.addEventListener("keydown", function (event) {
        if (event.key === "Escape" && modal.open) {
            closeNotes();
        }
    });
</script>

{% endblock %}
